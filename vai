#!/bin/bash
# VAI - Vast.ai Command Line Interface
# Quick access to all Vast.ai automation scripts

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPTS_DIR="$SCRIPT_DIR/SCRIPTS/python_scripts"

# Function to show help
show_help() {
    echo "üöÄ VAI - Vast.ai Workflow Command Interface"
    echo "============================================="
    echo ""
    echo "PRIMARY WORKFLOWS:"
    echo "  vai create [index] [gpu] [provision_script]  - Create and Monitor instance"
    echo "  vai exec <instance> <workflow> <image> <prompt>  - Execute workflow"
    echo ""
    echo "JOB MANAGEMENT:"
    echo "  vai cancel <instance> <job_id>           - Cancel specific job"
    echo "  vai cancel <instance> --list             - List all active jobs for instance"
    echo "  vai cancel <instance> --all              - Cancel ALL jobs for instance"
    echo "  vai cancel --all                         - Cancel ALL jobs across ALL instances"
    echo ""
    echo "INSTANCE MANAGEMENT:"
    echo "  vai destroy <instance>                   - Destroy specific instance"
    echo "  vai destroy --all                        - Destroy ALL instances"
    echo "  vai stop <instance>                      - Stop specific instance"
    echo "  vai stop --all                           - Stop ALL running instances"
    echo "  vai start <instance>                     - Start specific instance"
    echo "  vai start --all                          - Start ALL stopped instances"
    echo "  vai list                                 - List all instances with status"
    echo "  vai search [index] [gpu]                 - Search for GPU offers"
    echo ""
    echo "EXAMPLES:"
    echo "  vai create                                # Use defaults (index=0, RTX 3060, provision_test_3.sh)"
    echo "  vai create 1 \"RTX 4090\" provision_test_1.sh   # Custom settings"
    echo "  vai exec 26003629 wan2-2-I2V-FP8-Lightning.json test-image.png \"cat in space\""
    echo "  vai cancel 26003629 --list               # List all active jobs for instance"
    echo "  vai cancel 26003629 abc123def456         # Cancel specific job"
    echo "  vai cancel 26003629 --all                # Cancel ALL jobs for instance"
    echo "  vai cancel --all                         # Cancel ALL jobs across ALL instances"
    echo "  vai destroy 26003629                     # Destroy specific instance"
    echo "  vai stop --all                           # Stop all running instances"
    echo "  vai list                                 # List all instances"
    echo "  vai search                               # Search for RTX 3060 offers (default)"
    echo "  vai search 2 \"RTX 4090\"                 # Search for RTX 4090, select index 2"
    echo ""
    echo "HELP:"
    echo "  vai create --help                        # Show create_and_monitor.py help"
    echo "  vai exec --help                          # Show execute_workflow.py help"
    echo "  vai cancel --help                        # Show cancel_job.py help"
    echo "  vai destroy --help                       # Show destroy_instance.py help"
    echo "  vai stop --help                          # Show stop/start help"
    echo "  vai search --help                        # Show search help"
    echo "  vai help                                 # Show this help"
    echo ""
    echo "WORKFLOW FILES:"
    echo "  Available in: /workspace/ComfyUI/user/default/workflows/"
    echo "  - wan2-2-I2V-FP8-Lightning.json"
    echo ""
    echo "PROVISIONING SCRIPTS:"
    echo "  Available options: provision_test_1.sh, provision_test_2.sh, provision_test_3.sh (default)"
}

# Check if no arguments provided
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

# Get the command
COMMAND="$1"
shift  # Remove first argument, so $@ now contains the rest

case "$COMMAND" in
    "create"|"cm")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üéØ Create and Monitor Workflow Help"
            echo "===================================="
            echo "Usage: vai create [INDEX] [GPU_NAME] [PROVISIONING_SCRIPT]"
            echo ""
            echo "Arguments:"
            echo "  INDEX               Offer index to select (default: 0)"
            echo "  GPU_NAME            GPU to search for (default: 'RTX 3060')"
            echo "  PROVISIONING_SCRIPT Provisioning script to use (default: 'provision_test_3.sh')"
            echo ""
            echo "Examples:"
            echo "  vai create                            # Use all defaults"
            echo "  vai create 1                          # Use offer index 1"
            echo "  vai create 1 \"RTX 4090\"              # Custom GPU"
            echo "  vai create 1 \"RTX 4090\" provision_test_1.sh # Full custom"
            echo ""
            echo "This command will:"
            echo "  1. Search for GPU offers"
            echo "  2. Create instance with selected provisioning script"
            echo "  3. Monitor until instance is ready"
            echo "  4. Display instance ID when complete"
        else
            echo "üéØ Running Create and Monitor workflow..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/create_and_monitor.py" "$@"
        fi
        ;;
    
    "exec"|"execute")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚ö° Execute Workflow Help"
            echo "========================"
            echo "Usage: vai exec <INSTANCE_ID> <WORKFLOW_FILENAME> <IMAGE_FILENAME> \"<PROMPT>\""
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID"
            echo "  WORKFLOW_FILENAME  Workflow file (e.g., wan2-2-I2V-FP8-Lightning.json)"
            echo "  IMAGE_FILENAME     Image filename from TEMPLATES/images/ (e.g., test-image.png)"
            echo "  PROMPT             Text prompt for generation"
            echo ""
            echo "Examples:"
            echo "  vai exec 26003629 wan2-2-I2V-FP8-Lightning.json test-image.png \"cat in space\""
            echo "  vai exec 26003629 wan2-2-I2V-FP8-Lightning.json test-image.png \"beautiful landscape\""
            echo ""
            echo "This command will:"
            echo "  1. Auto-fetch SSH connection details from Vast.ai API"
            echo "  2. Upload your image from TEMPLATES/images/ to the instance"
            echo "  3. Execute the specified workflow with your prompt"
            echo "  4. Start background monitoring and logging"
            echo "  5. Display job ID for tracking progress"
            echo ""
            echo "Files locations:"
            echo "  Workflow files: /workspace/ComfyUI/user/default/workflows/"
            echo "  Image files: TEMPLATES/images/ (automatically prepended)"
            echo ""
            echo "Available images: test-image.png"
        else
            echo "‚ö° Running Execute Workflow..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/execute_workflow.py" "$@"
        fi
        ;;
    
    "cancel")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üõë Cancel Job Help"
            echo "=================="
            echo "Usage: vai cancel <INSTANCE_ID> <JOB_ID>"
            echo "       vai cancel <INSTANCE_ID> --list"
            echo "       vai cancel <INSTANCE_ID> --all"
            echo "       vai cancel --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID (optional when using --all globally)"
            echo "  JOB_ID             ComfyUI job ID to cancel"
            echo ""
            echo "Options:"
            echo "  --list, -l         List all active jobs for the instance"
            echo "  --all, -a          Cancel ALL jobs (for instance or globally)"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai cancel 26003629 --list               # List jobs for instance"
            echo "  vai cancel 26003629 abc123def456         # Cancel specific job"
            echo "  vai cancel 26003629 --all                # Cancel ALL jobs for instance"
            echo "  vai cancel --all                         # Cancel ALL jobs across ALL instances"
            echo "  vai cancel 26003629 --all --force        # Cancel all for instance without confirmation"
            echo ""
            echo "This command will:"
            echo "  1. Auto-fetch SSH connection details from Vast.ai API"
            echo "  2. Find jobs in running or pending queue"
            echo "  3. Cancel using appropriate method (interrupt/queue removal)"
            echo "  4. Verify cancellation completed successfully"
            echo "  5. When using --all globally, process all running instances"
        else
            echo "üõë Managing ComfyUI jobs..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/cancel_job.py" "$@"
        fi
        ;;
    
    "destroy")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üî• Destroy Instance Help"
            echo "========================"
            echo "Usage: vai destroy <INSTANCE_ID>"
            echo "       vai destroy --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to destroy"
            echo ""
            echo "Options:"
            echo "  --all, -a          Destroy ALL instances"
            echo "  --list, -l         List all instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai destroy 26003629                     # Destroy specific instance"
            echo "  vai destroy --all                        # Destroy ALL instances"
            echo "  vai destroy --all --force                # Destroy all without confirmation"
            echo "  vai destroy --list                       # List all instances"
            echo ""
            echo "‚ö†Ô∏è  WARNING: Destroying instances is IRREVERSIBLE!"
        else
            echo "üî• Managing instance destruction..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/destroy_instance.py" "$@"
        fi
        ;;
    
    "pause"|"stop")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚è∏Ô∏è Stop Instance Help"
            echo "====================="
            echo "Usage: vai stop <INSTANCE_ID>"
            echo "       vai stop --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to stop"
            echo ""
            echo "Options:"
            echo "  --all, -a          Stop ALL running instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai stop 26003629                        # Stop specific instance"
            echo "  vai stop --all                           # Stop ALL running instances"
            echo "  vai stop --all --force                   # Stop all without confirmation"
            echo ""
            echo "This command will stop instances to save costs while preserving data."
        else
            echo "‚è∏Ô∏è Managing instance stop..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" stop "$@"
        fi
        ;;
    
    "unpause"|"start")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚ñ∂Ô∏è Start Instance Help"
            echo "======================="
            echo "Usage: vai start <INSTANCE_ID>"
            echo "       vai start --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to start"
            echo ""
            echo "Options:"
            echo "  --all, -a          Start ALL stopped instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo "  --no-monitor       Skip detailed startup monitoring"
            echo ""
            echo "Examples:"
            echo "  vai start 26003629                       # Start specific instance with monitoring"
            echo "  vai start 26003629 --no-monitor          # Start without detailed monitoring"
            echo "  vai start --all                          # Start ALL stopped instances"
            echo "  vai start --all --force                  # Start all without confirmation"
            echo ""
            echo "This command will resume stopped instances and monitor startup progress by default."
        else
            echo "‚ñ∂Ô∏è Managing instance start..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" start "$@"
        fi
        ;;
    
    "list")
        echo "üìã Listing all instances..."
        cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" --list
        ;;
    
    "search")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üîç Search GPU Offers Help"
            echo "========================="
            echo "Usage: vai search [INDEX] [GPU_NAME]"
            echo ""
            echo "Arguments:"
            echo "  INDEX               Offer index to select (default: 0)"
            echo "  GPU_NAME            GPU to search for (default: 'RTX 3060')"
            echo ""
            echo "Examples:"
            echo "  vai search                                # Use defaults (index=0, RTX 3060)"
            echo "  vai search 2                              # Select index 2, RTX 3060"
            echo "  vai search 0 \"RTX 4090\"                  # Search RTX 4090, index 0"
            echo "  vai search 3 \"RTX A6000\"                 # Search RTX A6000, index 3"
            echo ""
            echo "This command will:"
            echo "  1. Search for available GPU offers on Vast.ai"
            echo "  2. Filter by price, bandwidth, and reliability"
            echo "  3. Sort by lowest 10-minute total cost"
            echo "  4. Display top 10 offers with details"
            echo "  5. Return the selected offer ID"
        else
            echo "üîç Searching for GPU offers..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/search_offers.py" "$@"
        fi
        ;;
    
    "help"|"--help"|"-h")
        show_help
        ;;
    
    *)
        echo "‚ùå Unknown command: $COMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac