#!/bin/bash
# VAI - Vast.ai Command Line Interface
# Quick access to all Vast.ai automation scripts

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPTS_DIR="$SCRIPT_DIR/SCRIPTS/python_scripts"

# Function to show help
show_help() {
    echo "üöÄ VAI - Vast.ai Workflow Command Interface"
    echo "============================================="
    echo ""
    echo "PRIMARY WORKFLOWS:"
    echo "  vai create <config_file>                        - Create instance from config file"
    echo "  vai exec <instance> <config_file>               - Execute workflow from config"
    echo "  vai extract <instance> <type>                   - Extract files from instance"
    echo "  vai oneshot <config_file>                       - Complete pipeline: create‚Üíexec‚Üíextract"
    echo ""
    echo "LEGACY WORKFLOWS:"
    echo "  vai create-legacy [index] [gpu] [provision_script] [disk_size]  - Create with manual args"
    echo ""
    echo "WORKFLOW MANAGEMENT:"
    echo "  vai workflow analyze <workflow_file>         - Analyze workflow and create config template"
    echo "  vai workflow list                            - List available workflow templates"
    echo ""
    echo "JOB MANAGEMENT:"
    echo "  vai cancel <instance> <job_id>           - Cancel specific job"
    echo "  vai cancel <instance> --list             - List all active jobs for instance"
    echo "  vai cancel <instance> --all              - Cancel ALL jobs for instance"
    echo "  vai cancel --all                         - Cancel ALL jobs across ALL instances"
    echo ""
    echo "INSTANCE MANAGEMENT:"
    echo "  vai destroy <instance>                   - Destroy specific instance"
    echo "  vai destroy --all                        - Destroy ALL instances"
    echo "  vai stop <instance>                      - Stop specific instance"
    echo "  vai stop --all                           - Stop ALL running instances"
    echo "  vai start <instance>                     - Start specific instance"
    echo "  vai start --all                          - Start ALL stopped instances"
    echo "  vai list                                 - List all instances with status"
    echo "  vai search [index] [gpu] [min_disk]      - Search for GPU offers"
    echo "  vai calculate <provision_script>         - Calculate provisioning download size"
    echo ""
    echo "SSH TUNNEL MANAGEMENT:"
    echo "  vai tunnel <instance>                    - Create SSH tunnel with auto port assignment"
    echo "  vai tunnel --list                        - List all active SSH tunnels"
    echo "  vai tunnel --stop <instance>             - Close specific SSH tunnel"
    echo "  vai tunnel --stop-all                    - Close all SSH tunnels"
    echo ""
    echo "DEBUGGING & CONFIGURATION:"
    echo "  vai ssh-key                              - Show detected SSH key location"
    echo ""
    echo "HELP & GUIDES:"
    echo "  vai guide                                - Show comprehensive workflow guide"
    echo "  vai help                                 - Show this help message"
    echo "  vai <command> --help                     - Show command-specific help"
    echo ""
    echo "EXAMPLES:"
    echo "  vai create wan2-2-I2V-FP8-Lightning-user_friendly.json  # Create from config"
    echo "  vai exec 26003629 wan2-2-I2V-FP8-Lightning-user_friendly.json"
    echo "  vai extract 26003629 content                    # Extract all images/videos from instance"
    echo "  vai oneshot wan2-2-I2V-FP8-Lightning-user_friendly.json # Complete pipeline"
    echo "  vai create-legacy                         # Legacy: Use defaults (index=0, RTX 3060, provision_test_3.sh)"
    echo "  vai create-legacy 1 \"RTX 4090\" provision_test_1.sh 200   # Legacy: Custom settings"
    echo "  vai workflow analyze TEMPLATES/1_workflows/new-workflow.json  # Create config template"
    echo "  vai workflow list                         # List available templates"
    echo "  vai cancel 26003629 --list               # List all active jobs for instance"
    echo "  vai cancel 26003629 abc123def456         # Cancel specific job"
    echo "  vai cancel 26003629 --all                # Cancel ALL jobs for instance"
    echo "  vai cancel --all                         # Cancel ALL jobs across ALL instances"
    echo "  vai destroy 26003629                     # Destroy specific instance"
    echo "  vai stop --all                           # Stop all running instances"
    echo "  vai list                                 # List all instances"
    echo "  vai search                               # Search for RTX 3060 offers (default 100GB)"
    echo "  vai search 2 \"RTX 4090\"                 # Search for RTX 4090, select index 2"
    echo "  vai search 0 \"RTX 3060\" 500             # Search for RTX 3060 with 500GB+ disk"
    echo "  vai calculate provision_test_3.sh        # Calculate provisioning download size"
    echo ""
    echo "HELP:"
    echo "  vai create --help                        # Show create_and_monitor.py help"
    echo "  vai create-config --help                 # Show config-based create help"
    echo "  vai exec --help                          # Show execute_workflow.py help"
    echo "  vai extract --help                       # Show extract_files.py help"
    echo "  vai oneshot --help                       # Show oneshot.py help"
    echo "  vai workflow --help                      # Show workflow management help"
    echo "  vai cancel --help                        # Show cancel_job.py help"
    echo "  vai destroy --help                       # Show destroy_instance.py help"
    echo "  vai stop --help                          # Show stop/start help"
    echo "  vai search --help                        # Show search help"
    echo "  vai calculate --help                     # Show calculate help"
    echo "  vai help                                 # Show this help"
    echo ""
    echo "WORKFLOW FILES:"
    echo "  Available in: /workspace/ComfyUI/user/default/workflows/"
    echo "  - wan2-2-I2V-FP8-Lightning.json"
    echo ""
    echo "PROVISIONING SCRIPTS:"
    echo "  Available options: provision_test_1.sh, provision_test_2.sh, provision_test_3.sh (default)"
}

# Check if no arguments provided
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

# Get the command
COMMAND="$1"
shift  # Remove first argument, so $@ now contains the rest

case "$COMMAND" in
    "create"|"cm")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üéØ Create Instance from Config Help"
            echo "==================================="
            echo "Usage: vai create <CONFIG_FILENAME>"
            echo ""
            echo "Arguments:"
            echo "  CONFIG_FILENAME     Configuration file from TEMPLATES/3_configs/"
            echo ""
            echo "Examples:"
            echo "  vai create wan2-2-I2V-FP8-Lightning-user_friendly.json"
            echo "  vai create my-custom-workflow-detailed.json"
            echo ""
            echo "This command will:"
            echo "  1. Load instance settings from config file"
            echo "  2. Extract GPU name, index, provisioning script, disk size"
            echo "  3. Search for matching GPU offers"
            echo "  4. Create instance with specified settings"
            echo "  5. Monitor until instance is ready"
            echo "  6. Display instance ID and exec command when complete"
            echo ""
            echo "Configuration files:"
            echo "  Generated by: vai workflow analyze <workflow.json>"
            echo "  Location: TEMPLATES/3_configs/"
            echo "  Contains: instance_config section with all creation settings"
            echo ""
            echo "After creation, use:"
            echo "  vai exec <instance_id> <same_config_file>"
            echo ""
            echo "Legacy command available as: vai create-legacy"
            echo ""
            echo "Available config files:"
            if [ -d "$SCRIPT_DIR/TEMPLATES/3_configs" ]; then
                for file in "$SCRIPT_DIR/TEMPLATES/3_configs"/*.json; do
                    if [ -f "$file" ]; then
                        echo "  - $(basename "$file")"
                    fi
                done | sort -u
            fi
        else
            echo "üéØ Creating instance from configuration..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/create_and_monitor_config.py" "$@"
        fi
        ;;
    
    "create-legacy"|"cl")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üéØ Create Instance (Legacy) Help"
            echo "================================"
            echo "Usage: vai create-legacy [INDEX] [GPU_NAME] [PROVISIONING_SCRIPT] [DISK_SIZE]"
            echo ""
            echo "Arguments:"
            echo "  INDEX               Offer index to select (default: 0)"
            echo "  GPU_NAME            GPU to search for (default: 'RTX 3060')"
            echo "  PROVISIONING_SCRIPT Provisioning script to use (default: 'provision_test_3.sh')"
            echo "  DISK_SIZE           Disk size in GB (default: 100)"
            echo ""
            echo "Examples:"
            echo "  vai create-legacy                         # Use all defaults"
            echo "  vai create-legacy 1                       # Use index 1, other defaults"
            echo "  vai create-legacy 0 \\\"RTX 4090\\\"           # RTX 4090, other defaults"
            echo "  vai create-legacy 1 \\\"RTX 4090\\\" provision_test_1.sh 200"
            echo ""
            echo "This command will:"
            echo "  1. Search for GPU offers matching the specified GPU"
            echo "  2. Select offer at the specified index"
            echo "  3. Create instance with manual parameters"
            echo "  4. Monitor until instance is ready"
            echo "  5. Display instance ID when complete"
            echo ""
            echo "Note: For modern workflow-based creation, use 'vai create' instead"
        else
            echo "üéØ Creating instance (legacy mode)..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/create_and_monitor.py" "$@"
        fi
        ;;
    
    "exec"|"execute")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚ö° Execute Workflow Help"
            echo "========================"
            echo "Usage: vai exec <INSTANCE_ID> <CONFIG_FILENAME>"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID"
            echo "  CONFIG_FILENAME    Configuration file from TEMPLATES/3_configs/"
            echo ""
            echo "Examples:"
            echo "  vai exec 26003629 wan2-2-I2V-FP8-Lightning-user_friendly.json"
            echo "  vai exec 26003629 my-custom-workflow-detailed.json"
            echo ""
            echo "This command will:"
            echo "  1. Load configuration from TEMPLATES/3_configs/"
            echo "  2. Auto-detect and upload required images from TEMPLATES/4_images/"
            echo "  3. Load text prompts from TEMPLATES/5_prompts/ (for .txt references)"
            echo "  4. Apply all configuration changes to the workflow"
            echo "  5. Execute the modified workflow on the instance"
            echo "  6. Display job ID for tracking progress"
            echo ""
            echo "Configuration files:"
            echo "  Generated by: vai workflow analyze <workflow.json>"
            echo "  Location: TEMPLATES/3_configs/"
            echo "  Contains: Instance settings, workflow parameters, file references"
            echo ""
            echo "File handling:"
            echo "  - .png/.jpg files ‚Üí Auto-upload from TEMPLATES/4_images/"
            echo "  - .txt files ‚Üí Load content from TEMPLATES/5_prompts/"
            echo "  - All changes applied automatically based on config"
        else
            echo "‚ö° Running Execute Workflow (Config-based)..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/execute_workflow_config.py" "$@"
        fi
        ;;
    
    "oneshot")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üöÄ Oneshot Pipeline Help"
            echo "========================"
            echo "Usage: vai oneshot <CONFIG_FILENAME>"
            echo ""
            echo "Arguments:"
            echo "  CONFIG_FILENAME    Configuration file from TEMPLATES/3_configs/"
            echo ""
            echo "Examples:"
            echo "  vai oneshot wan2-2-I2V-FP8-Lightning-user_friendly.json"
            echo "  vai oneshot wan2-2-I2V-FP8-Lightning-user_friendly.json --destroy"
            echo "  vai oneshot my-custom-workflow-detailed.json"
            echo ""
            echo "This command will:"
            echo "  1. Create instance from config file"
            echo "  2. Monitor until ComfyUI is fully ready"
            echo "  3. Execute workflow immediately"
            echo "  4. Auto-extract content when workflow completes"
            echo "  5. Auto-destroy instance (if --destroy flag used)"
            echo "  6. Display final results and file locations"
            echo ""
            echo "Options:"
            echo "  --destroy    Automatically destroy instance after successful extraction"
            echo ""
            echo "Pipeline stages:"
            echo "  üîç Search for GPU offers"
            echo "  üöÄ Create instance"
            echo "  ‚è≥ Wait for full provisioning (ComfyUI ready)"
            echo "  ‚ö° Execute workflow immediately"
            echo "  üì• Auto-extract content"
            echo "  üí£ Auto-destroy (if --destroy used)"
            echo "  üéâ Complete pipeline"
            echo ""
            echo "Note: This waits for full provisioning like 'vai create'."
            echo "Use 'vai create' + 'vai exec' for manual control."
        else
            echo "üöÄ Running complete oneshot pipeline..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/oneshot.py" "$@"
        fi
        ;;
    
    "extract")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üì• Extract Files Help"
            echo "===================="
            echo "Usage: vai extract <INSTANCE_ID> <TYPE> [options]"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID"
            echo "  TYPE               Type of files to extract: workflows, content, all, custom"
            echo ""
            echo "Options:"
            echo "  --output-dir, -o   Local output directory (default: IMPORT)"
            echo "  --remote-path, -p  Remote path for custom extraction"
            echo "  --pattern, -f      File pattern for custom extraction (default: *)"
            echo "  --ssh-key, -k      Path to SSH private key"
            echo ""
            echo "Examples:"
            echo "  vai extract 26003629 workflows                    # Extract all JSON workflows"
            echo "  vai extract 26003629 content                      # Extract all images/videos"
            echo "  vai extract 26003629 all                          # Extract everything"
            echo "  vai extract 26003629 custom -p /workspace/output -f '*.png'"
            echo ""
            echo "This command will:"
            echo "  1. Connect to the instance via SSH"
            echo "  2. Search for files matching the specified type/pattern"
            echo "  3. Download files with organized naming: {timestamp}_{instance-id}_{filename}"
            echo "  4. Recreate folder structure locally under IMPORT/"
            echo "  5. Display summary of downloaded files"
            echo ""
            echo "File organization:"
            echo "  - Files are prefixed with timestamp and instance ID for organization"
            echo "  - Original folder structure is preserved under IMPORT/"
            echo "  - Example: IMPORT/output/20240918_123456_26003629_image.png"
        else
            echo "üì• Extracting files from ComfyUI instance..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/extract_files.py" "$@"
        fi
        ;;
    
    "cancel")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üõë Cancel Job Help"
            echo "=================="
            echo "Usage: vai cancel <INSTANCE_ID> <JOB_ID>"
            echo "       vai cancel <INSTANCE_ID> --list"
            echo "       vai cancel <INSTANCE_ID> --all"
            echo "       vai cancel --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID (optional when using --all globally)"
            echo "  JOB_ID             ComfyUI job ID to cancel"
            echo ""
            echo "Options:"
            echo "  --list, -l         List all active jobs for the instance"
            echo "  --all, -a          Cancel ALL jobs (for instance or globally)"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai cancel 26003629 --list               # List jobs for instance"
            echo "  vai cancel 26003629 abc123def456         # Cancel specific job"
            echo "  vai cancel 26003629 --all                # Cancel ALL jobs for instance"
            echo "  vai cancel --all                         # Cancel ALL jobs across ALL instances"
            echo "  vai cancel 26003629 --all --force        # Cancel all for instance without confirmation"
            echo ""
            echo "This command will:"
            echo "  1. Auto-fetch SSH connection details from Vast.ai API"
            echo "  2. Find jobs in running or pending queue"
            echo "  3. Cancel using appropriate method (interrupt/queue removal)"
            echo "  4. Verify cancellation completed successfully"
            echo "  5. When using --all globally, process all running instances"
        else
            echo "üõë Managing ComfyUI jobs..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/cancel_job.py" "$@"
        fi
        ;;
    
    "destroy")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üî• Destroy Instance Help"
            echo "========================"
            echo "Usage: vai destroy <INSTANCE_ID>"
            echo "       vai destroy --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to destroy"
            echo ""
            echo "Options:"
            echo "  --all, -a          Destroy ALL instances"
            echo "  --list, -l         List all instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai destroy 26003629                     # Destroy specific instance"
            echo "  vai destroy --all                        # Destroy ALL instances"
            echo "  vai destroy --all --force                # Destroy all without confirmation"
            echo "  vai destroy --list                       # List all instances"
            echo ""
            echo "‚ö†Ô∏è  WARNING: Destroying instances is IRREVERSIBLE!"
        else
            echo "üî• Managing instance destruction..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/destroy_instance.py" "$@"
        fi
        ;;
    
    "pause"|"stop")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚è∏Ô∏è Stop Instance Help"
            echo "====================="
            echo "Usage: vai stop <INSTANCE_ID>"
            echo "       vai stop --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to stop"
            echo ""
            echo "Options:"
            echo "  --all, -a          Stop ALL running instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo ""
            echo "Examples:"
            echo "  vai stop 26003629                        # Stop specific instance"
            echo "  vai stop --all                           # Stop ALL running instances"
            echo "  vai stop --all --force                   # Stop all without confirmation"
            echo ""
            echo "This command will stop instances to save costs while preserving data."
        else
            echo "‚è∏Ô∏è Managing instance stop..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" stop "$@"
        fi
        ;;
    
    "unpause"|"start")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "‚ñ∂Ô∏è Start Instance Help"
            echo "======================="
            echo "Usage: vai start <INSTANCE_ID>"
            echo "       vai start --all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID to start"
            echo ""
            echo "Options:"
            echo "  --all, -a          Start ALL stopped instances"
            echo "  --force, -f        Skip confirmation prompt"
            echo "  --no-monitor       Skip detailed startup monitoring"
            echo ""
            echo "Examples:"
            echo "  vai start 26003629                       # Start specific instance with monitoring"
            echo "  vai start 26003629 --no-monitor          # Start without detailed monitoring"
            echo "  vai start --all                          # Start ALL stopped instances"
            echo "  vai start --all --force                  # Start all without confirmation"
            echo ""
            echo "This command will resume stopped instances and monitor startup progress by default."
        else
            echo "‚ñ∂Ô∏è Managing instance start..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" start "$@"
        fi
        ;;
    
    "list")
        echo "üìã Listing all instances..."
        cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/pause_instance.py" --list
        ;;
    
    "search")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üîç Search GPU Offers Help"
            echo "========================="
            echo "Usage: vai search [INDEX] [GPU_NAME] [MIN_DISK_SIZE]"
            echo ""
            echo "Arguments:"
            echo "  INDEX               Offer index to select (default: 0)"
            echo "  GPU_NAME            GPU to search for (default: 'RTX 3060')"
            echo "  MIN_DISK_SIZE       Minimum disk size in GB (default: 100)"
            echo ""
            echo "Examples:"
            echo "  vai search                                # Use defaults (index=0, RTX 3060, 100GB)"
            echo "  vai search 2                              # Select index 2, RTX 3060, 100GB"
            echo "  vai search 0 \"RTX 4090\"                  # Search RTX 4090, index 0, 100GB"
            echo "  vai search 0 \"RTX 3060\" 500              # Search RTX 3060 with 500GB+ disk"
            echo ""
            echo "This command will:"
            echo "  1. Search for available GPU offers on Vast.ai"
            echo "  2. Filter by price, bandwidth, reliability, and disk size"
            echo "  3. Sort by lowest 10-minute total cost"
            echo "  4. Display top 10 offers with details"
            echo "  5. Return the selected offer ID"
        else
            echo "üîç Searching for GPU offers..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/search_offers.py" "$@"
        fi
        ;;
    
    "calculate"|"calc")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üìä Calculate Provisioning Size Help"
            echo "==================================="
            echo "Usage: vai calculate <PROVISIONING_SCRIPT>"
            echo ""
            echo "Arguments:"
            echo "  PROVISIONING_SCRIPT  Provisioning script to analyze"
            echo ""
            echo "Options:"
            echo "  --verbose, -v        Verbose output with full URLs"
            echo "  --list-files, -l     List all URLs found in script"
            echo "  --update-configs, -u Update matching config files with recommended disk size"
            echo ""
            echo "Examples:"
            echo "  vai calculate provision_test_3.sh"
            echo "  vai calculate wan2-2-I2V-FP8-Lightning.sh"
            echo "  vai calculate provision_test_3.sh --verbose"
            echo "  vai calculate provision_test_3.sh --list-files"
            echo "  vai calculate wan2-2-I2V-FP8-Lightning.sh --update-configs"
            echo ""
            echo "This command will:"
            echo "  1. Parse provisioning script for all downloads"
            echo "  2. Check file sizes from remote servers"
            echo "  3. Calculate total model/file downloads"
            echo "  4. Estimate package installation sizes"
            echo "  5. Recommend appropriate disk size"
            echo ""
            echo "Available scripts:"
            if [ -d "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts" ]; then
                for file in "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts"/*.sh "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts/archive"/*.sh; do
                    if [ -f "$file" ]; then
                        echo "  - $(basename "$file")"
                    fi
                done | sort -u
            fi
        else
            if [ $# -eq 0 ]; then
                echo "‚ùå Please provide a provisioning script name"
                echo "Example: vai calculate provision_test_3.sh"
                echo ""
                echo "Available scripts:"
                if [ -d "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts" ]; then
                    for file in "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts"/*.sh "$SCRIPT_DIR/TEMPLATES/2_provisioning_scripts/archive"/*.sh; do
                        if [ -f "$file" ]; then
                            echo "  - $(basename "$file")"
                        fi
                    done | sort -u
                fi
                exit 1
            fi
            echo "üìä Calculating provisioning download size..."
            cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/components/calculate_provision_size.py" "$@"
        fi
        ;;
    
    "workflow"|"wf")
        # Check if --help is requested or no subcommand
        if [[ "$1" == "--help" || "$1" == "-h" || $# -eq 0 ]]; then
            echo "üéØ Workflow Management Help"
            echo "==========================="
            echo "Usage: vai workflow <subcommand> [options]"
            echo ""
            echo "SUBCOMMANDS:"
            echo "  analyze <workflow_file>     - Analyze workflow and create editable config"
            echo "  list                        - List available workflow templates"
            echo ""
            echo "ANALYZE OPTIONS:"
            echo "  --format, -f <format>       - Output format: user_friendly (default), detailed, minimal"
            echo "  --output, -o <path>         - Custom output path (auto-generated if not specified)"
            echo "  --pretty, -p                - Pretty print the configuration to console"
            echo ""
            echo "EXAMPLES:"
            echo "  vai workflow analyze my-workflow.json"
            echo "  vai workflow analyze my-workflow.json --format minimal"
            echo "  vai workflow analyze my-workflow.json --pretty"
            echo "  vai workflow list"
            echo ""
            echo "This will:"
            echo "  1. Extract all configurable parameters from any ComfyUI workflow"
            echo "  2. Remove UI clutter (positioning, colors, etc.)"
            echo "  3. Create clean, editable configuration files"
            echo "  4. Save to TEMPLATES/3_configs/ for easy editing"
            echo ""
            echo "Output formats:"
            echo "  user_friendly: Simple, easy-to-edit format for end users"
            echo "  detailed:      More structured but comprehensive format"
            echo "  minimal:       Just the essential configurable parts"
            echo ""
            echo "Available workflow files:"
            if [ -d "$SCRIPT_DIR/TEMPLATES/1_workflows" ]; then
                for file in "$SCRIPT_DIR/TEMPLATES/1_workflows"/*.json; do
                    if [ -f "$file" ]; then
                        echo "  - $(basename "$file")"
                    fi
                done | sort -u
            fi
        else
            SUBCOMMAND="$1"
            shift
            
            case "$SUBCOMMAND" in
                "analyze"|"a")
                    if [ $# -eq 0 ]; then
                        echo "‚ùå Please provide a workflow filename"
                        echo "Example: vai workflow analyze my-workflow.json"
                        echo "Available files:"
                        if [ -d "$SCRIPT_DIR/TEMPLATES/1_workflows" ]; then
                            for file in "$SCRIPT_DIR/TEMPLATES/1_workflows"/*.json; do
                                if [ -f "$file" ]; then
                                    echo "  - $(basename "$file")"
                                fi
                            done
                        fi
                        exit 1
                    fi
                    
                    # Get the filename (first argument)
                    WORKFLOW_FILE="$1"
                    shift  # Remove filename from arguments
                    
                    # Check if it's already a full path or just a filename
                    if [[ "$WORKFLOW_FILE" == *"/"* ]]; then
                        # It's a full path, use as-is
                        FULL_PATH="$WORKFLOW_FILE"
                    else
                        # It's just a filename, prepend the templates path
                        FULL_PATH="$SCRIPT_DIR/TEMPLATES/1_workflows/$WORKFLOW_FILE"
                    fi
                    
                    # Check if file exists
                    if [ ! -f "$FULL_PATH" ]; then
                        echo "‚ùå Workflow file not found: $FULL_PATH"
                        echo "Available files in TEMPLATES/1_workflows/:"
                        if [ -d "$SCRIPT_DIR/TEMPLATES/1_workflows" ]; then
                            for file in "$SCRIPT_DIR/TEMPLATES/1_workflows"/*.json; do
                                if [ -f "$file" ]; then
                                    echo "  - $(basename "$file")"
                                fi
                            done
                        fi
                        exit 1
                    fi
                    
                    echo "üîç Analyzing workflow template: $(basename "$FULL_PATH")"
                    cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/workflows/analyze_workflow_generic.py" "$FULL_PATH" "$@"
                    ;;
                "list"|"ls")
                    echo "üìã Available workflow templates:"
                    echo "================================"
                    if [ -d "$SCRIPT_DIR/TEMPLATES/1_workflows" ]; then
                        for file in "$SCRIPT_DIR/TEMPLATES/1_workflows"/*.json; do
                            if [ -f "$file" ]; then
                                basename "$file"
                            fi
                        done
                    else
                        echo "No workflow templates found in TEMPLATES/1_workflows/"
                    fi
                    echo ""
                    echo "üìã Available config templates:"
                    echo "============================="
                    if [ -d "$SCRIPT_DIR/TEMPLATES/3_configs" ]; then
                        for file in "$SCRIPT_DIR/TEMPLATES/3_configs"/*.json; do
                            if [ -f "$file" ]; then
                                basename "$file"
                            fi
                        done
                    else
                        echo "No config templates found in TEMPLATES/3_configs/"
                        echo "Use 'vai workflow analyze' to create some!"
                    fi
                    ;;
                *)
                    echo "‚ùå Unknown workflow subcommand: $SUBCOMMAND"
                    echo "Use 'vai workflow --help' for available options"
                    exit 1
                    ;;
            esac
        fi
        ;;
    
    "help"|"--help"|"-h")
        show_help
        ;;
    
    "guide"|"workflow-guide")
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "                    üìö COMFYUI WORKFLOW GUIDE"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        echo "This guide walks through the complete workflow from creating a"
        echo "ComfyUI workflow to running it on Vast.ai instances."
        echo ""
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "üìã PHASE 1: PREPARE YOUR WORKFLOW"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo ""
        echo "1Ô∏è‚É£  Create your workflow in ComfyUI:"
        echo "    ‚Ä¢ Design and test locally"
        echo "    ‚Ä¢ Export as workflow.json"
        echo "    ‚Ä¢ Place in TEMPLATES/1_workflows/"
        echo ""
        echo "2Ô∏è‚É£  Create provisioning script:"
        echo "    ‚Ä¢ Copy template: TEMPLATES/2_provisioning_scripts/template.sh"
        echo "    ‚Ä¢ Rename to match workflow: workflow.sh"
        echo "    ‚Ä¢ Update script with required models"
        echo ""
        echo "3Ô∏è‚É£  Analyze workflow requirements:"
        echo "    vai workflow analyze workflow.json"
        echo "    ‚Ä¢ Reviews nodes and dependencies"
        echo "    ‚Ä¢ Identifies required models"
        echo "    ‚Ä¢ Runs vai calculate automatically"
        echo ""
        echo "4Ô∏è‚É£  Calculate disk requirements:"
        echo "    vai calculate workflow.sh --update-configs"
        echo "    ‚Ä¢ Scans all model downloads"
        echo "    ‚Ä¢ Calculates total disk usage"
        echo "    ‚Ä¢ Updates all config files"
        echo ""
        echo "5Ô∏è‚É£  Create user-friendly config:"
        echo "    ‚Ä¢ Edit workflow-user_friendly.json"
        echo "    ‚Ä¢ Set prompt placeholders"
        echo "    ‚Ä¢ Configure image inputs"
        echo "    ‚Ä¢ Adjust parameters"
        echo ""
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "‚ö° PHASE 2: RUN YOUR WORKFLOW"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo ""
        echo "Option A: Manual control"
        echo "    vai create workflow.json         # Create & provision"
        echo "    vai exec 12345 workflow.json     # Execute workflow"
        echo "    vai extract 12345 content        # Download results"
        echo "    vai destroy 12345                # Clean up"
        echo ""
        echo "Option B: One command"
        echo "    vai oneshot workflow.json        # All steps automated"
        echo "    vai oneshot workflow.json --destroy  # + auto cleanup"
        echo ""
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "üìÅ FILE STRUCTURE"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo ""
        echo "TEMPLATES/"
        echo "‚îú‚îÄ‚îÄ workflows/"
        echo "‚îÇ   ‚îî‚îÄ‚îÄ workflow.json              # ComfyUI workflow"
        echo "‚îú‚îÄ‚îÄ provisioning_scripts/"
        echo "‚îÇ   ‚îî‚îÄ‚îÄ workflow.sh                # Model downloads"
        echo "‚îú‚îÄ‚îÄ configs/"
        echo "‚îÇ   ‚îú‚îÄ‚îÄ workflow.json              # Auto-generated"
        echo "‚îÇ   ‚îî‚îÄ‚îÄ workflow-user_friendly.json # User inputs"
        echo "‚îú‚îÄ‚îÄ prompts/"
        echo "‚îÇ   ‚îî‚îÄ‚îÄ prompt.txt                 # Text prompts"
        echo "‚îî‚îÄ‚îÄ images/"
        echo "    ‚îî‚îÄ‚îÄ input.png                  # Input images"
        echo ""
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "üí° TIPS"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo ""
        echo "‚Ä¢ Use descriptive names: 'sdxl-portrait-upscale.json'"
        echo "‚Ä¢ Test workflows locally before deploying"
        echo "‚Ä¢ Keep provisioning scripts minimal"
        echo "‚Ä¢ Use --update-configs to sync disk sizes"
        echo "‚Ä¢ Check logs in SCRIPTS/logs/ for debugging"
        echo ""
        echo "For more help: vai help <command>"
        ;;

    "ssh-key")
        # Show SSH key detection information
        python3 "$PYTHON_SCRIPTS_DIR/utils/show_ssh_key.py"
        ;;

    "tunnel"|"t")
        # Check if --help is requested
        if [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "üîó SSH Tunnel Management Help"
            echo "=============================="
            echo "Usage: vai tunnel <INSTANCE_ID>"
            echo "       vai tunnel --list"
            echo "       vai tunnel --stop <INSTANCE_ID>"
            echo "       vai tunnel --stop-all"
            echo ""
            echo "Arguments:"
            echo "  INSTANCE_ID        Vast.ai instance ID"
            echo ""
            echo "Options:"
            echo "  --list, -l         List all active SSH tunnels"
            echo "  --stop, -s         Close tunnel for specific instance"
            echo "  --stop-all         Close all active tunnels"
            echo ""
            echo "Examples:"
            echo "  vai tunnel 26003629                      # Create tunnel for instance"
            echo "  vai tunnel --list                        # List all active tunnels"
            echo "  vai tunnel --stop 26003629               # Close specific tunnel"
            echo "  vai tunnel --stop-all                    # Close all tunnels"
            echo ""
            echo "This command will:"
            echo "  1. Auto-detect SSH connection details from Vast.ai API"
            echo "  2. Allocate next available local port (8188, 8189, 8190...)"
            echo "  3. Create SSH tunnel in background"
            echo "  4. Track tunnel process for management"
            echo "  5. Display localhost URL for ComfyUI access"
            echo ""
            echo "Features:"
            echo "  - Automatic port allocation (no conflicts)"
            echo "  - Background tunnel process (terminal stays free)"
            echo "  - Persistent across sessions (saved to ~/.vai_tunnels.json)"
            echo "  - Easy cleanup with --stop commands"
        else
            if [[ "$1" == "--list" || "$1" == "-l" ]]; then
                echo "üì° Listing active SSH tunnels..."
                cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/utils/tunnel_manager.py" list
            elif [[ "$1" == "--stop" || "$1" == "-s" ]]; then
                if [ -z "$2" ]; then
                    echo "‚ùå Please provide instance ID to stop"
                    echo "Usage: vai tunnel --stop <instance_id>"
                    exit 1
                fi
                echo "üîí Closing SSH tunnel for instance $2..."
                cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/utils/tunnel_manager.py" close "$2"
            elif [[ "$1" == "--stop-all" ]]; then
                echo "üîí Closing all SSH tunnels..."
                cd "$SCRIPT_DIR" && poetry run python "$PYTHON_SCRIPTS_DIR/utils/tunnel_manager.py" close-all
            else
                # Create tunnel for specific instance
                if [ -z "$1" ]; then
                    echo "‚ùå Please provide instance ID"
                    echo "Usage: vai tunnel <instance_id>"
                    exit 1
                fi

                INSTANCE_ID="$1"
                echo "üîó Creating SSH tunnel for instance $INSTANCE_ID..."

                # Fetch SSH info from Vast.ai API
                cd "$SCRIPT_DIR" && poetry run python -c "
import os
import sys
import requests
from dotenv import load_dotenv
sys.path.append('$PYTHON_SCRIPTS_DIR')
from utils.tunnel_manager import TunnelManager

load_dotenv()

api_key = os.getenv('VAST_API_KEY')
if not api_key:
    print('‚ùå VAST_API_KEY not found in environment')
    sys.exit(1)

headers = {'Authorization': f'Bearer {api_key}'}
response = requests.get('https://console.vast.ai/api/v0/instances/', headers=headers)
instances = response.json().get('instances', [])

instance_id = '$INSTANCE_ID'
found = False

for instance in instances:
    if str(instance.get('id')) == instance_id:
        ssh_host = instance.get('ssh_host')
        ssh_port = instance.get('ssh_port')

        if not ssh_host or not ssh_port:
            print(f'‚ùå Instance {instance_id} is not ready for SSH yet')
            sys.exit(1)

        # Create tunnel
        tunnel_manager = TunnelManager()
        local_port = tunnel_manager.create_tunnel(
            instance_id=instance_id,
            ssh_host=ssh_host,
            ssh_port=ssh_port,
            remote_port=8188
        )

        print(f'\nüåê Access ComfyUI at: http://localhost:{local_port}')
        print(f'üí° To close: vai tunnel --stop {instance_id}')
        found = True
        break

if not found:
    print(f'‚ùå Instance {instance_id} not found')
    sys.exit(1)
"
            fi
        fi
        ;;

    *)
        echo "‚ùå Unknown command: $COMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac